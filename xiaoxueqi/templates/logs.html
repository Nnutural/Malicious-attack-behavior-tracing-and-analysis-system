{% extends "layout.html" %}

{% block title %}æ—¥å¿—åˆ†æ - æ”»å‡»æº¯æºåˆ†æç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
  .toolbar {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    padding: 10px 12px;
    border: 1px solid #e6e6e6;
    background: #fafafa;
    border-radius: 10px;
    margin: 12px 0 14px;
  }
  .toolbar-left, .toolbar-right { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .btn {
    border: 1px solid #2b6cb0;
    background: #3182ce;
    color: #fff;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .btn:hover { background: #2b6cb0; }

  .btn-ghost{
    border: 1px solid #e6e6e6;
    background: #fff;
    color: #111827;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display:inline-flex;
    align-items:center;
    gap: 8px;
  }
  .btn-ghost:hover{ background:#f8fafc; }

  .field {
    display:flex;
    align-items:center;
    gap:8px;
    padding: 8px 10px;
    border: 1px solid #e6e6e6;
    background: #fff;
    border-radius: 8px;
  }
  .field label { color:#374151; font-size:13px; font-weight:600; }
  .field select{
    border: none;
    outline: none;
    font-size: 13px;
    min-width: 220px;
  }

  table { width: 100%; border-collapse: collapse; border: 1px solid #e6e6e6; background:#fff; border-radius:10px; overflow:hidden; table-layout: fixed; }
  thead th { text-align:left; background:#f8fafc; border-bottom:1px solid #e6e6e6; color:#334155; font-size:13px; padding:10px 12px; white-space:nowrap; }
  tbody td { border-bottom:1px solid #f0f0f0; padding:10px 12px; font-size:13px; color:#111827; vertical-align:top; }
  tbody tr:hover td { background:#fcfcfc; }
  tbody tr:last-child td { border-bottom:none; }

  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .clip { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .link { color:#2563eb; text-decoration:none; font-weight:600; }
  .link:hover { text-decoration:underline; }

  .pagination { display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:10px; margin-top:12px; }
  .pager-left{ justify-self:start; }
  .pager-mid{ justify-self:center; color:#555; font-size:13px; }
  .pager-right{ justify-self:end; }
  .page-btn, .page-btn-disabled{
    display:inline-flex; align-items:center; gap:6px;
    padding: 8px 10px; border-radius:8px;
    border:1px solid #e6e6e6; background:#fff;
    color:#111827; text-decoration:none; font-weight:600; font-size:13px; white-space:nowrap;
  }
  .page-btn:hover{ background:#f8fafc; }
  .page-btn-disabled{ opacity:.5; cursor:not-allowed; }

  .flash { margin: 10px 0 0; padding: 10px 12px; border-radius: 8px; border: 1px solid #e6e6e6; background: #fff; font-size: 13px; }
  .flash.info { border-color: #bfdbfe; background: #eff6ff; color: #1e3a8a; }
  .flash.error { border-color: #fecaca; background: #fff1f2; color: #7f1d1d; }
</style>
{% endblock %}

{% block content %}

  <h2>ä¸»æœºæ—¥å¿—åˆ†æ</h2>
  <p>æ‰«ææœ¬æœº Windows Event Logï¼Œå½’ä¸€åŒ–åå†™å…¥ SQL Serverï¼ˆdbo.HostLogsï¼‰ã€‚æ”¯æŒæŒ‰ <b>host_name(ComputerName)</b> ç²¾ç¡®ç­›é€‰ã€‚</p>

  {% set page_size = 20 %}
  {% set total_pages = ((total + page_size - 1) // page_size) if total is not none else 1 %}
  {% if total_pages < 1 %}{% set total_pages = 1 %}{% endif %}

  <div class="toolbar">
    <div class="toolbar-left">
      <form method="post" action="{{ url_for('logs.collect', host_name=host_name) }}">
        <button class="btn" type="submit" title="æ‰«ææœ¬æœº Security/System å¹¶å†™å…¥æ•°æ®åº“">
          <span aria-hidden="true">ğŸ–¥ï¸</span>
          <span>æ‰«ææœ¬æœºæ—¥å¿—å¹¶å…¥åº“</span>
        </button>
      </form>

      <form method="get" action="{{ url_for('logs.list_logs') }}">
        <div class="field">
          <label for="host_name">ä¸»æœºç­›é€‰</label>
          <select id="host_name" name="host_name">
            <option value="">å…¨éƒ¨ä¸»æœº</option>
            {% for hn in host_names %}
              <option value="{{ hn }}" {% if host_name == hn %}selected{% endif %}>{{ hn }}</option>
            {% endfor %}
          </select>
          <button class="btn-ghost" type="submit">ç­›é€‰</button>
          <a class="btn-ghost" href="{{ url_for('logs.list_logs') }}">æ¸…é™¤</a>
        </div>
      </form>
    </div>

    <div class="toolbar-right" style="color:#555;font-size:13px;">
      <span>ğŸ“¦ æ€»æ•°ï¼š<b>{{ total }}</b></span>
      <span>ğŸ“„ ç¬¬ <b>{{ page }}</b> / <b>{{ total_pages }}</b> é¡µ</span>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash {{ category }}" style="width:100%;">
            <strong>{{ category }}:</strong> {{ msg }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <h3>æ—¥å¿—åˆ—è¡¨</h3>

  <table>
    <thead>
      <tr>
        <th style="width:80px;">ID</th>
        <th style="width:190px;">æ—¶é—´</th>
        <th style="width:200px;">ä¸»æœºï¼ˆhost_nameï¼‰</th>
        <th style="width:110px;">çº§åˆ«</th>
        <th style="width:110px;">äº‹ä»¶ID</th>
        <th>æ¶ˆæ¯</th>
        <th style="width:90px;">æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr>
        <td class="mono clip">{{ log.id }}</td>
        <td class="mono clip" title="{{ log.timestamp }}">{{ log.timestamp }}</td>
        <td class="clip" title="{{ log.hostname }}">{{ log.hostname }}</td>
        <td class="clip">{{ log.level }}</td>
        <td class="mono clip">{{ log.event_id }}</td>
        <td class="clip" title="{{ log.message }}">{{ log.message }}</td>
        <td><a class="link" href="{{ url_for('logs.detail', log_id=log.id) }}">è¯¦æƒ…</a></td>
      </tr>
      {% endfor %}

      {% if logs|length == 0 %}
      <tr>
        <td colspan="7" style="color:#6b7280; padding: 14px 12px;">
          æš‚æ— æ•°æ®ã€‚è¯·ç‚¹å‡»ä¸Šæ–¹â€œæ‰«ææœ¬æœºæ—¥å¿—å¹¶å…¥åº“â€æˆ–è°ƒæ•´ç­›é€‰æ¡ä»¶ã€‚
        </td>
      </tr>
      {% endif %}
    </tbody>
  </table>

  <div class="pagination">
    <div class="pager-left">
      {% if page > 1 %}
        <a class="page-btn" href="{{ url_for('logs.list_logs', page=page-1, host_name=host_name) }}">â¬… ä¸Šä¸€é¡µ</a>
      {% else %}
        <span class="page-btn-disabled">â¬… ä¸Šä¸€é¡µ</span>
      {% endif %}
    </div>

    <div class="pager-mid">
      ç¬¬ <span class="mono">{{ page }}</span> / <span class="mono">{{ total_pages }}</span> é¡µ
    </div>

    <div class="pager-right">
      {% if page < total_pages %}
        <a class="page-btn" href="{{ url_for('logs.list_logs', page=page+1, host_name=host_name) }}">ä¸‹ä¸€é¡µ â¡</a>
      {% else %}
        <span class="page-btn-disabled">ä¸‹ä¸€é¡µ â¡</span>
      {% endif %}
    </div>
  </div>

{% endblock %}