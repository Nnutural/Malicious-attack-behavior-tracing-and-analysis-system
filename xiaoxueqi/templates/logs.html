{% extends "layout.html" %}

{% block title %}æ—¥å¿—åˆ†æ - æ”»å‡»æº¯æºåˆ†æç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
  /* è½»é‡ç¾åŒ–ï¼šä¸å¼•å…¥å¤–éƒ¨åº“ï¼Œå°½é‡è·Ÿå…¶ä»–é¡µé¢ä¸€è‡´ */
  .logs-page h2 { margin-bottom: 6px; }
  .logs-page .desc { color: #666; margin-top: 0; }

  .toolbar {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    padding: 10px 12px;
    border: 1px solid #e6e6e6;
    background: #fafafa;
    border-radius: 10px;
    margin: 12px 0 14px;
  }

  .db-form {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  .db-label { font-size: 13px; color: #555; }
  .db-input {
    border: 1px solid #e6e6e6;
    border-radius: 8px;
    padding: 8px 10px;
    min-width: 180px;
  }

  .btn {
    border: 1px solid #2b6cb0;
    background: #3182ce;
    color: #fff;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .btn:hover { background: #2b6cb0; }
  .btn:active { transform: translateY(1px); }
  .btn.secondary {
    border-color: #475569;
    background: #64748b;
  }
  .btn.secondary:hover { background: #475569; }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 2px 10px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid #e6e6e6;
    background: #fff;
    white-space: nowrap;
  }
  .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .badge.info .dot { background: #22c55e; }
  .badge.warning .dot { background: #f59e0b; }
  .badge.error .dot { background: #ef4444; }

  .stats {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
    color: #555;
    font-size: 13px;
  }
  .stat {
    border: 1px solid #e6e6e6;
    background: #fff;
    padding: 6px 10px;
    border-radius: 999px;
  }

  .flash {
    margin: 10px 0 0;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #e6e6e6;
    background: #fff;
    font-size: 13px;
  }
  .flash.info { border-color: #bfdbfe; background: #eff6ff; color: #1e3a8a; }
  .flash.error { border-color: #fecaca; background: #fff1f2; color: #7f1d1d; }
  .flash strong { margin-right: 6px; }

  /* === è¡¨æ ¼å›ºå®šåˆ—å®½ï¼šå…³é”®ç‚¹ === */
  table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #e6e6e6;
    border-radius: 10px;
    overflow: hidden;
    background: #fff;

    table-layout: fixed; /* å…³é”®ï¼šåˆ—å®½ä¸éšå†…å®¹å˜åŒ– */
  }
  thead th {
    text-align: left;
    background: #f8fafc;
    border-bottom: 1px solid #e6e6e6;
    color: #334155;
    font-size: 13px;
    padding: 10px 12px;

    white-space: nowrap;
  }
  tbody td {
    border-bottom: 1px solid #f0f0f0;
    padding: 10px 12px;
    font-size: 13px;
    color: #111827;
    vertical-align: top;
  }
  tbody tr:hover td { background: #fcfcfc; }
  tbody tr:last-child td { border-bottom: none; }

  /* è¶…é•¿å†…å®¹å¤„ç†ï¼šé»˜è®¤ä¸€è¡Œçœç•¥å· */
  .clip {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .link { color: #2563eb; text-decoration: none; font-weight: 600; }
  .link:hover { text-decoration: underline; }

  /* åˆ†é¡µï¼šå·¦ä¸Šä¸€é¡µï¼Œä¸­é—´é¡µæ•°/æ€»é¡µæ•°ï¼Œå³ä¸‹ä¸€é¡µ */
  .pagination {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 10px;
    margin-top: 12px;
  }
  .pager-left { justify-self: start; }
  .pager-mid { justify-self: center; color: #555; font-size: 13px; }
  .pager-right { justify-self: end; }

  .page-btn, .page-btn-disabled {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #e6e6e6;
    background: #fff;
    color: #111827;
    text-decoration: none;
    font-weight: 600;
    font-size: 13px;
    white-space: nowrap;
  }
  .page-btn:hover { background: #f8fafc; }
  .page-btn-disabled { opacity: .5; cursor: not-allowed; }

  @media (max-width: 760px) {
    .hide-sm { display: none; }
    .pagination { grid-template-columns: 1fr; justify-items: stretch; }
    .pager-left, .pager-right { justify-self: stretch; }
    .page-btn, .page-btn-disabled { justify-content: center; width: 100%; }
    .pager-mid { justify-self: center; }
  }
</style>
{% endblock %}

{% block content %}
<div class="logs-page">

  <h2>ä¸»æœºæ—¥å¿—åˆ†æ</h2>
  <p class="desc">ç‚¹å‡»æŒ‰é’®æ‰«ææœ¬æœº Windows Event Logï¼Œå½’ä¸€åŒ–åå†™å…¥ SQL Serverï¼ˆdbo.HostLogsï¼‰ã€‚</p>

  {# è®¡ç®—æ€»é¡µæ•°ï¼ˆä¸æ”¹åç«¯é€»è¾‘ï¼‰ #}
  {% set page_size = 20 %}
  {% set total_pages = ((total + page_size - 1) // page_size) if total is not none else 1 %}
  {% if total_pages < 1 %}{% set total_pages = 1 %}{% endif %}

  <div class="toolbar">
    <form method="post" action="{{ url_for('logs.collect') }}">
      <button class="btn" type="submit" title="æ‰«ææœ¬æœº Security/System å¹¶å†™å…¥æ•°æ®åº“">
        <span aria-hidden="true">ğŸ–¥ï¸</span>
        <span>æ‰«ææœåŠ¡å™¨æ—¥å¿—å¹¶å…¥åº“</span>
      </button>
    </form>

    <form class="db-form" method="post" action="{{ url_for('logs.set_db_server') }}">
      <label class="db-label" for="db_server">SQL Server</label>
      <input
        id="db_server"
        name="db_server"
        class="db-input"
        type="text"
        placeholder="localhost,1433"
        value="{{ db_server }}"
      >
      <button class="btn secondary" type="submit">åº”ç”¨</button>
    </form>

    <div class="stats">
      <span class="stat">DBï¼š<b>{{ db_server }}</b></span>
      <span class="stat">ğŸ“¦ æ€»æ•°ï¼š<b>{{ total }}</b></span>
      <span class="stat">ğŸ“„ å½“å‰é¡µï¼š<b>{{ page }}</b></span>
      <span class="stat">ğŸ§­ æ€»é¡µæ•°ï¼š<b>{{ total_pages }}</b></span>
    </div>
  </div>

  {# flash æ¶ˆæ¯ï¼šç¨å¾®åŠ ä¸ªé¢œè‰² #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="flash {{ category }}">
          <strong>{{ category }}:</strong> {{ msg }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <h3 style="margin-top: 14px;">æ—¥å¿—åˆ—è¡¨</h3>

  <table>
    <thead>
      <tr>
        <th style="width: 80px;">ID</th>
        <th style="width: 190px;">æ—¶é—´</th>
        <th style="width: 180px;">ä¸»æœº</th>
        <th style="width: 120px;">çº§åˆ«</th>
        <th style="width: 110px;">äº‹ä»¶ID</th>
        <th>æ¶ˆæ¯</th>
        <th style="width: 90px;">æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr>
        <td class="mono clip" title="{{ log.id }}">{{ log.id }}</td>
        <td class="mono clip" title="{{ log.timestamp }}">{{ log.timestamp }}</td>
        <td class="clip" title="{{ log.hostname }}">{{ log.hostname }}</td>
        <td>
          {% if log.level == 'ERROR' %}
            <span class="badge error"><span class="dot"></span>ERROR</span>
          {% elif log.level == 'WARNING' %}
            <span class="badge warning"><span class="dot"></span>WARNING</span>
          {% else %}
            <span class="badge info"><span class="dot"></span>INFO</span>
          {% endif %}
        </td>
        <td class="mono clip" title="{{ log.event_id }}">{{ log.event_id }}</td>
        <td class="clip" title="{{ log.message }}">
          {{ log.message }}
        </td>
        <td><a class="link" href="{{ url_for('logs.detail', log_id=log.id) }}">è¯¦æƒ…</a></td>
      </tr>
      {% endfor %}

      {% if logs|length == 0 %}
      <tr>
        <td colspan="7" style="color:#6b7280; padding: 14px 12px;">
          æš‚æ— æ•°æ®ã€‚è¯·ç‚¹å‡»ä¸Šæ–¹â€œæ‰«ææœ¬æœºæ—¥å¿—å¹¶å…¥åº“â€ã€‚
        </td>
      </tr>
      {% endif %}
    </tbody>
  </table>

  <div class="pagination">
    <div class="pager-left">
      {% if page > 1 %}
        <a class="page-btn" href="{{ url_for('logs.list_logs', page=page-1) }}">â¬… ä¸Šä¸€é¡µ</a>
      {% else %}
        <span class="page-btn-disabled">â¬… ä¸Šä¸€é¡µ</span>
      {% endif %}
    </div>

    <div class="pager-mid">
      ç¬¬ <span class="mono">{{ page }}</span> / <span class="mono">{{ total_pages }}</span> é¡µ
    </div>

    <div class="pager-right">
      {% if page < total_pages %}
        <a class="page-btn" href="{{ url_for('logs.list_logs', page=page+1) }}">ä¸‹ä¸€é¡µ â¡</a>
      {% else %}
        <span class="page-btn-disabled">ä¸‹ä¸€é¡µ â¡</span>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
