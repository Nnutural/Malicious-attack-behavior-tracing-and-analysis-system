{% extends "layout.html" %}

{% block title %}æ—¥å¿—åˆ†æ - æ”»å‡»æº¯æºåˆ†æç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
  .toolbar {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    padding: 10px 12px;
    border: 1px solid #e6e6e6;
    background: #fafafa;
    border-radius: 10px;
    margin: 12px 0 14px;
  }
  .toolbar-left, .toolbar-right { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .db-form {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  .db-label { font-size: 13px; color: #555; }
  .db-input {
    border: 1px solid #e6e6e6;
    border-radius: 8px;
    padding: 8px 10px;
    min-width: 180px;
  }

  .btn {
    border: 1px solid #2b6cb0;
    background: #3182ce;
    color: #fff;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }
  .btn:hover { background: #2b6cb0; }
  .btn:active { transform: translateY(1px); }
  .btn.secondary {
    border-color: #475569;
    background: #64748b;
  }
  .btn.secondary:hover { background: #475569; }

  .btn-ghost{
    border: 1px solid #e6e6e6;
    background: #fff;
    color: #111827;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    text-decoration: none;
    display:inline-flex;
    align-items:center;
    gap: 8px;
  }
  .btn-ghost:hover{ background:#f8fafc; }

  .field {
    display:flex;
    align-items:center;
    gap:8px;
    padding: 8px 10px;
    border: 1px solid #e6e6e6;
    background: #fff;
    border-radius: 8px;
  }
  .field label { color:#374151; font-size:13px; font-weight:600; }
  .field select{
    border: none;
    outline: none;
    font-size: 13px;
    min-width: 220px;
  }

  table { width: 100%; border-collapse: collapse; border: 1px solid #e6e6e6; background:#fff; border-radius:10px; overflow:hidden; table-layout: fixed; }
  thead th { text-align:left; background:#f8fafc; border-bottom:1px solid #e6e6e6; color:#334155; font-size:13px; padding:10px 12px; white-space:nowrap; }
  tbody td { border-bottom:1px solid #f0f0f0; padding:10px 12px; font-size:13px; color:#111827; vertical-align:top; }
  tbody tr:hover td { background:#fcfcfc; }
  tbody tr:last-child td { border-bottom:none; }

  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .clip { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .link { color:#2563eb; text-decoration:none; font-weight:600; }
  .link:hover { text-decoration:underline; }

  .pagination { display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:10px; margin-top:12px; }
  .pager-left{ justify-self:start; }
  .pager-mid{ justify-self:center; color:#555; font-size:13px; }
  .pager-right{ justify-self:end; }
  .page-btn, .page-btn-disabled{
    display:inline-flex; align-items:center; gap:6px;
    padding: 8px 10px; border-radius:8px;
    border:1px solid #e6e6e6; background:#fff;
    color:#111827; text-decoration:none; font-weight:600; font-size:13px; white-space:nowrap;
  }
  .page-btn:hover{ background:#f8fafc; }
  .page-btn-disabled{ opacity:.5; cursor:not-allowed; }

  .page-jump {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .page-input {
    width: 72px;
    padding: 6px 8px;
    border: 1px solid #e6e6e6;
    border-radius: 6px;
  }

  .flash { margin: 10px 0 0; padding: 10px 12px; border-radius: 8px; border: 1px solid #e6e6e6; background: #fff; font-size: 13px; }
  .flash.info { border-color: #bfdbfe; background: #eff6ff; color: #1e3a8a; }
  .flash.error { border-color: #fecaca; background: #fff1f2; color: #7f1d1d; }

  .sync-panel { display: flex; gap: 12px; flex-wrap: wrap; width: 100%; }
  .sync-card {
    border: 1px solid #e6e6e6;
    background: #fff;
    border-radius: 10px;
    padding: 10px 12px;
    min-width: 280px;
  }
  .sync-title { font-size: 13px; font-weight: 700; color: #334155; margin-bottom: 8px; }
  .sync-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .sync-input {
    border: 1px solid #e6e6e6;
    border-radius: 8px;
    padding: 8px 10px;
    min-width: 140px;
  }
  .sync-status { font-size: 12px; color: #4b5563; margin-top: 6px; }
  .sync-msg { margin-top: 6px; padding: 6px 8px; border-radius: 6px; border: 1px solid #e6e6e6; font-size: 12px; background: #f8fafc; }
  .sync-msg.info { border-color: #bfdbfe; background: #eff6ff; color: #1e3a8a; }
  .sync-msg.error { border-color: #fecaca; background: #fff1f2; color: #7f1d1d; }
  .sync-msg.success { border-color: #86efac; background: #ecfdf3; color: #065f46; }

  .logontracer-entry{
    margin-top: 16px;
    padding: 14px 16px;
    border-radius: 10px;
    border: 1px dashed #e5e7eb;
    background: #fff;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }
  .logontracer-entry p{
    margin: 0;
    color: #4b5563;
    font-size: 13px;
  }
</style>
{% endblock %}

{% block content %}

  <h2>ä¸»æœºæ—¥å¿—åˆ†æ</h2>
  <p>æ‰«ææœåŠ¡å™¨ Windows Event Logï¼Œå½’ä¸€åŒ–åå†™å…¥ SQL Serverï¼ˆdbo.HostLogsï¼‰ã€‚æ”¯æŒæŒ‰ <b>host_name(ComputerName)</b> ç²¾ç¡®ç­›é€‰ã€‚</p>

  {% set page_size = 20 %}
  {% if total_pages is not defined %}
    {% set total_pages = ((total + page_size - 1) // page_size) if total is not none else 1 %}
    {% if total_pages < 1 %}{% set total_pages = 1 %}{% endif %}
  {% endif %}

  <div class="toolbar">
    <div class="toolbar-left">
      <form method="post" action="{{ url_for('logs.collect', host_name=host_name) }}">
        <button class="btn" type="submit" title="æ‰«ææœ¬æœº Security/System å¹¶å†™å…¥æ•°æ®åº“">
          <span aria-hidden="true">ğŸ–¥ï¸</span>
          <span>æ‰«ææœåŠ¡å™¨æ—¥å¿—å¹¶å…¥åº“</span>
        </button>
      </form>

      <form method="get" action="{{ url_for('logs.list_logs') }}">
        <div class="field">
          <label for="host_name">ä¸»æœºç­›é€‰</label>
          <select id="host_name" name="host_name">
            <option value="">å…¨éƒ¨ä¸»æœº</option>
            {% for hn in host_names %}
              <option value="{{ hn }}" {% if host_name == hn %}selected{% endif %}>{{ hn }}</option>
            {% endfor %}
          </select>
          <button class="btn-ghost" type="submit">ç­›é€‰</button>
          <a class="btn-ghost" href="{{ url_for('logs.list_logs') }}">æ¸…é™¤</a>
        </div>
      </form>

      <form class="db-form" method="post" action="{{ url_for('logs.set_db_server') }}">
        <input type="hidden" name="host_name" value="{{ host_name or '' }}">
        <label class="db-label" for="db_server">SQL Server</label>
        <input
          id="db_server"
          name="db_server"
          class="db-input"
          type="text"
          placeholder="localhost,1433"
          value="{{ db_server }}"
        >
        <button class="btn secondary" type="submit">åº”ç”¨</button>
      </form>

      <div class="sync-panel">
        <div class="sync-card">
          <div class="sync-title">è½¯åŒæ­¥æ—¶é’Ÿï¼ˆLeaderï¼‰</div>
          <form method="post" action="{{ url_for('logs.start_time_sync_service') }}">
            <input type="hidden" name="host_name" value="{{ host_name or '' }}">
            <button class="btn" type="submit">å¯ç”¨åŒæ­¥æœåŠ¡</button>
          </form>
          <div class="sync-status">
            åŒæ­¥æœåŠ¡çŠ¶æ€ï¼š
            {% if time_service_status and time_service_status.running %}
              <b>Running</b>
            {% else %}
              <b>Stopped</b>
            {% endif %}
            ï¼Œç«¯å£ï¼š<b>{{ (time_service_status.port if time_service_status else time_sync_default_port) }}</b>
          </div>
        </div>
        <div class="sync-card">
          <div class="sync-title">è½¯åŒæ­¥æ—¶é’Ÿï¼ˆClientï¼‰</div>
          <form id="time-sync-client-form">
            <div class="sync-row">
              <input id="time-sync-target" class="sync-input" name="target_ip" type="text" placeholder="ç›®æ ‡IPï¼Œä¾‹å¦‚ 10.0.0.5" required>
              <input id="time-sync-port" class="sync-input" name="port" type="number" placeholder="ç«¯å£ {{ time_sync_default_port }}" min="1" max="65535">
              <button class="btn secondary" type="submit">å¯¹è¯¥ä¸»æœºè¿›è¡Œæ—¶é’ŸåŒæ­¥</button>
            </div>
          </form>
          <div id="time-sync-client-msg" class="sync-msg info">å°šæœªå¼€å§‹åŒæ­¥ã€‚</div>
        </div>
      </div>
    </div>

    <div class="toolbar-right" style="color:#555;font-size:13px;">
      <span>DBï¼š<b>{{ db_server }}</b></span>
      <span>ğŸ“¦ æ€»æ•°ï¼š<b>{{ total }}</b></span>
      <span>ğŸ“„ ç¬¬ <b>{{ page }}</b> / <b>{{ total_pages }}</b> é¡µ</span>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash {{ category }}" style="width:100%;">
            <strong>{{ category }}:</strong> {{ msg }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <div class="pagination">
    <div class="pager-left">
      {% if page > 1 %}
        <a class="page-btn" href="{{ url_for('logs.list_logs', page=page-1, host_name=host_name) }}">â¬… ä¸Šä¸€é¡µ</a>
      {% else %}
        <span class="page-btn-disabled">â¬… ä¸Šä¸€é¡µ</span>
      {% endif %}
    </div>

    <div class="pager-mid">
      <form class="page-jump" method="get" action="{{ url_for('logs.list_logs') }}">
        <input type="hidden" name="host_name" value="{{ host_name or '' }}">
        <span>é¡µç </span>
        <input
          class="page-input"
          type="number"
          name="page"
          min="1"
          max="{{ total_pages }}"
          value="{{ page }}"
        >
        <button class="btn-ghost" type="submit">è·³è½¬</button>
        <span>/ {{ total_pages }}</span>
      </form>
    </div>

    <div class="pager-right">
      {% if page < total_pages %}
        <a class="page-btn" href="{{ url_for('logs.list_logs', page=page+1, host_name=host_name) }}">ä¸‹ä¸€é¡µ â¡</a>
      {% else %}
        <span class="page-btn-disabled">ä¸‹ä¸€é¡µ â¡</span>
      {% endif %}
    </div>
  </div>

  <h3>æ—¥å¿—åˆ—è¡¨</h3>

  <table>
    <thead>
      <tr>
        <th style="width:80px;">ID</th>
        <th style="width:190px;">æ—¶é—´</th>
        <th style="width:200px;">ä¸»æœºï¼ˆhost_nameï¼‰</th>
        <th style="width:110px;">çº§åˆ«</th>
        <th style="width:110px;">äº‹ä»¶ID</th>
        <th>æ¶ˆæ¯</th>
        <th style="width:90px;">æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr>
        <td class="mono clip">{{ log.id }}</td>
        <td class="mono clip" title="{{ log.timestamp }}">{{ log.timestamp }}</td>
        <td class="clip" title="{{ log.hostname }}">{{ log.hostname }}</td>
        <td class="clip">{{ log.level }}</td>
        <td class="mono clip">{{ log.event_id }}</td>
        <td class="clip" title="{{ log.message }}">{{ log.message }}</td>
        <td><a class="link" href="{{ url_for('logs.detail', log_id=log.id) }}">è¯¦æƒ…</a></td>
      </tr>
      {% endfor %}

      {% if logs|length == 0 %}
      <tr>
        <td colspan="7" style="color:#6b7280; padding: 14px 12px;">
          æš‚æ— æ•°æ®ã€‚è¯·ç‚¹å‡»ä¸Šæ–¹â€œæ‰«ææœåŠ¡å™¨æ—¥å¿—å¹¶å…¥åº“â€æˆ–è°ƒæ•´ç­›é€‰æ¡ä»¶ã€‚
        </td>
      </tr>
      {% endif %}
    </tbody>
  </table>

  <div class="logontracer-entry">
    <a class="btn" href="{{ url_for('logs.logontracer_page') }}">
      ç™»å½•ä¼šè¯å¯è§†åŒ–ï¼ˆLogonTracerï¼‰
    </a>
    <p>è¿›å…¥å¯è§†åŒ–åˆ†æé¡µé¢ï¼ŒæŒ‰æ—¶é—´èŒƒå›´æ„å»ºç™»å½•å…³ç³»å›¾ã€ä¼šè¯åˆ—è¡¨ä¸æ—¶é—´çº¿ã€‚</p>
  </div>

{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const form = document.getElementById("time-sync-client-form");
    const msgBox = document.getElementById("time-sync-client-msg");
    if (!form || !msgBox) return;

    const defaultPort = {{ time_sync_default_port }};
    let polling = false;
    let pollTimer = null;

    function setMsg(text, level) {
      msgBox.textContent = text;
      msgBox.className = "sync-msg " + (level || "info");
    }

    function formatMs(value) {
      if (value === null || value === undefined) return "n/a";
      const num = Number(value);
      if (Number.isNaN(num)) return "n/a";
      const sign = num >= 0 ? "+" : "";
      return sign + num.toFixed(1) + "ms";
    }

    function stopPolling() {
      polling = false;
      if (pollTimer) {
        clearTimeout(pollTimer);
        pollTimer = null;
      }
    }

    function pollStatus() {
      fetch("{{ url_for('logs.time_sync_client_status') }}")
        .then((resp) => resp.json())
        .then((data) => {
          if (!data) {
            stopPolling();
            setMsg("åŒæ­¥ç»“æŸï¼šFAILEDï¼ŒåŸå› =çŠ¶æ€è¯»å–å¤±è´¥", "error");
            return;
          }
          if (data.running) {
            pollTimer = setTimeout(pollStatus, 1000);
            return;
          }
          stopPolling();
          if (data.ok) {
            const offsetText = formatMs(data.offset_ms);
            const delayText = formatMs(data.delay_ms);
            const sourceText = data.source_ip || "";
            setMsg(`åŒæ­¥ç»“æŸï¼šOKï¼Œoffset=${offsetText}ï¼Œdelay=${delayText}ï¼Œsource=${sourceText}`, "success");
          } else {
            const reason = data.message || "æœªçŸ¥é”™è¯¯";
            setMsg(`åŒæ­¥ç»“æŸï¼šFAILEDï¼ŒåŸå› =${reason}`, "error");
          }
        })
        .catch(() => {
          stopPolling();
          setMsg("åŒæ­¥ç»“æŸï¼šFAILEDï¼ŒåŸå› =çŠ¶æ€æ¥å£å¼‚å¸¸", "error");
        });
    }

    form.addEventListener("submit", function (event) {
      event.preventDefault();
      const targetIp = document.getElementById("time-sync-target").value.trim();
      let portValue = document.getElementById("time-sync-port").value.trim();
      if (!targetIp) {
        setMsg("å¼€å§‹åŒæ­¥å¤±è´¥ï¼šç›®æ ‡åœ°å€ä¸ºç©º", "error");
        return;
      }
      if (!portValue) {
        portValue = String(defaultPort);
      }
      setMsg(`å¼€å§‹åŒæ­¥ï¼šç›®æ ‡ ${targetIp}:${portValue}ï¼ˆåå°æ‰§è¡Œï¼‰`, "info");
      stopPolling();

      fetch("{{ url_for('logs.start_time_sync_client') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ target_ip: targetIp, port: portValue })
      })
        .then((resp) => resp.json().then((data) => ({ ok: resp.ok, data })))
        .then(({ ok, data }) => {
          if (!ok) {
            const reason = (data && data.message) ? data.message : "è¯·æ±‚å¤±è´¥";
            setMsg(`å¼€å§‹åŒæ­¥å¤±è´¥ï¼š${reason}`, "error");
            return;
          }
          if (data && data.started === false) {
            const reason = data.message || "å·²æœ‰ä»»åŠ¡åœ¨è¿›è¡Œ";
            setMsg(`å¼€å§‹åŒæ­¥å¤±è´¥ï¼š${reason}`, "error");
            if (data.running) {
              polling = true;
              pollTimer = setTimeout(pollStatus, 1000);
            }
            return;
          }
          polling = true;
          pollTimer = setTimeout(pollStatus, 1000);
        })
        .catch(() => {
          setMsg("å¼€å§‹åŒæ­¥å¤±è´¥ï¼šè¯·æ±‚å¼‚å¸¸", "error");
        });
    });
  })();
</script>
{% endblock %}
