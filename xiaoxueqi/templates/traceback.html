{% extends "layout.html" %}

{% block title %}æº¯æºåˆ†æ - æ”»å‡»æº¯æºåˆ†æç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='traceback/traceback.css') }}">
{% endblock %}

{% block content %}
<div class="tb-page">
  <!-- é¡¶éƒ¨ -->
  <div class="tb-header">
    <div>
      <h2>æº¯æºåˆ†æ</h2>
      <div class="tb-subtitle">
        é¢å‘ High å‘Šè­¦çš„æ”»å‡»è·¯å¾„é‡å»ºï¼šå…¥å£ â†’ æ¨ªå‘ â†’ ææƒ/æŒä¹…åŒ– â†’ å¤–ä¼  â†’ C2/å½’å› 
      </div>
    </div>

    <div class="tb-toolbar">
      <button class="btn btn-secondary" id="btnRefresh">åˆ·æ–°åˆ—è¡¨</button>
      <button class="btn btn-primary" id="btnAnalyze">è¿è¡Œåˆ†æ</button>

      <label class="switch">
        <input type="checkbox" id="chkCache" checked>
        <span>ä½¿ç”¨ç¼“å­˜</span>
      </label>

      <span class="tb-status" id="status"></span>
    </div>
  </div>

  <!-- ä¸»ä½“ï¼šå·¦ä¾§å›ºå®š + å³ä¾§å›ºå®š -->
  <div class="tb-layout">
    <!-- å·¦ä¾§ï¼šHigh å‘Šè­¦ -->
    <aside class="tb-left">
      <div class="panel">
        <div class="panel-title">High å‘Šè­¦</div>
        <div id="alertsList" class="alert-list">
          <div class="muted">ç‚¹å‡»â€œè¿è¡Œåˆ†æâ€ç”Ÿæˆå‘Šè­¦ä¸æº¯æºæŠ¥å‘Šã€‚</div>
        </div>
      </div>
    </aside>

    <!-- å³ä¾§ï¼šæ¦‚è§ˆ + Tabs -->
    <main class="tb-right">
      <div class="panel">
        <div class="panel-title">æº¯æºæ¦‚è§ˆ</div>

        <div id="summaryEmpty" class="muted">è¯·é€‰æ‹©ä¸€ä¸ªå‘Šè­¦ã€‚</div>

        <div id="summaryContent" style="display:none;">
          <div class="summary-grid">
            <div class="card">
              <div class="card-title">å…¥å£ï¼ˆInitial Accessï¼‰</div>
              <div class="card-body" id="entryBody"></div>
            </div>

            <div class="card">
              <div class="card-title">æ‰§è¡Œï¼ˆExecution / Process Treeï¼‰</div>
              <div class="card-body" id="execBody"></div>
            </div>

            <div class="card">
              <div class="card-title">æ¨ªå‘ç§»åŠ¨ï¼ˆLateral Movementï¼‰</div>
              <div class="card-body" id="lateralBody"></div>
            </div>

            <div class="card">
              <div class="card-title">å¤–ä¼ ï¼ˆExfiltrationï¼‰</div>
              <div class="card-body" id="exfilBody"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="tabs">
          <button class="tab active" data-tab="graph">æ”»å‡»å›¾è°±</button>
          <button class="tab" data-tab="timeline">æ—¶é—´çº¿</button>
          <button class="tab" data-tab="ioc">IOC / æƒ…æŠ¥ / å½’å› </button>
          <button class="tab" data-tab="raw">åŸå§‹ JSON</button>
          <button class="tab" data-tab="ai-report">AI ç ”åˆ¤æŠ¥å‘Š âœ¨</button>
        </div>

        <!-- å›¾è°± TABï¼šå›¾ä¾‹æ¨ªæ’æ”¾å›¾ä¸Šæ–¹ï¼›è¯¦æƒ…æ”¾å›¾ä¸‹æ–¹ -->
        <section class="tab-content active" id="tab-graph">
          <div class="graph-legend-row">
            <div class="legend-item"><span class="dot dot-attack"></span>AttackEvent</div>
            <div class="legend-item"><span class="dot dot-tech"></span>Technique</div>
            <div class="legend-item"><span class="dot dot-proc"></span>Process</div>
            <div class="legend-item"><span class="dot dot-file"></span>File</div>
            <div class="legend-item"><span class="dot dot-user"></span>User</div>
            <div class="legend-item"><span class="dot dot-ip"></span>IP</div>
            <div class="legend-item"><span class="dot dot-domain"></span>Domain</div>
          </div>

          <div id="graph" class="graph"></div>

          <div class="graph-detail">
            <div class="panel-title">è¯¦æƒ…ï¼ˆç‚¹å‡»èŠ‚ç‚¹/è¾¹ï¼‰</div>
            <pre id="graphDetail">{}</pre>
          </div>
        </section>

        <section class="tab-content" id="tab-timeline">
          <div id="timelineBox" class="muted">æš‚æ— æ—¶é—´çº¿ã€‚</div>
          <div class="panel-title" style="margin-top:12px;">äº‹ä»¶è¯¦æƒ…</div>
          <pre id="timelineDetail">{}</pre>
        </section>

        <section class="tab-content" id="tab-ioc">
          <div id="iocBox" class="muted">æš‚æ—  IOCã€‚</div>
        </section>

        <section class="tab-content" id="tab-raw">
          <pre id="rawJson">{}</pre>
        </section>

        <section class="tab-content" id="tab-ai-report">
          <div style="margin-bottom: 12px;">
            <button class="btn btn-primary" id="btnGenAI">ğŸ¤– ç”Ÿæˆ/åˆ·æ–° AI æŠ¥å‘Š</button>
            <span id="aiStatus" class="muted" style="margin-left:10px;"></span>
          </div>
          <div id="aiReportBox" class="markdown-body pre-dark" style="background:#fff; color:#111; border:1px solid #eee; padding:20px;">
            <div class="muted">è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”ŸæˆæŠ¥å‘Šã€‚</div>
          </div>
      </section>
      </div>
    </main>
  </div>
</div>

<!-- ç»™ JS æä¾› API åœ°å€ -->
<script>
  window.__TRACEBACK_API__ = {
    analyze: "{{ url_for('traceback.api_analyze') }}",
    high_alerts: "{{ url_for('traceback.api_high_alerts') }}"
  };
</script>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="{{ url_for('static', filename='traceback/traceback.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}