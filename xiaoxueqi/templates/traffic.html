{% extends "layout.html" %}

{% block title %}æµé‡åˆ†æ - æ”»å‡»æº¯æºåˆ†æç³»ç»Ÿ{% endblock %}

{% block content %}

<div class="page-head">
  <div class="page-head-row">
    <div>
      <h2>ç½‘ç»œæµé‡åˆ†æ</h2>
      <p class="muted">
        åœ¨çº¿æŠ“åŒ…ä½¿ç”¨ <b>dumpcap</b> å­è¿›ç¨‹å†™å…¥ pcapng æ–‡ä»¶ï¼Œåœæ­¢åè‡ªåŠ¨è§£æå¹¶å…¥åº“ï¼ˆæ›´ç¨³å®šï¼Œé€‚åˆæ¼”ç¤ºï¼‰ã€‚
      </p>
    </div>
  </div>
</div>

<style>
  /* ===== traffic é¡µé¢å±€éƒ¨å¢å¼ºï¼ˆé¿å…å½±å“å…¶ä»–é¡µé¢ï¼‰ ===== */
  .tf-card-title{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .tf-hint{
    font-size:12px;
    color: var(--muted);
    line-height:1.55;
    margin:0;
  }

  .tf-toolbar{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    align-items:flex-end;
  }
  .tf-field{
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width: 220px;
  }
  .tf-field.wide{ min-width: 420px; }
  .tf-field.small{ min-width: 180px; }

  .tf-field label{
    font-size:12px;
    color:#4b5563;
    font-weight:700;
  }
  .tf-field input,
  .tf-field select{
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:9px 10px;
    font-size:14px;
    background:#fff;
  }
  .tf-field .help{
    font-size:12px;
    color:#64748b;
    margin-top:2px;
  }

  .tf-actions{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  .tf-status{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#f8fafc;
    font-size:13px;
    color:#0f172a;
    margin-top:10px;
    line-height: 1.5;
    word-break: break-word;
  }
  .tf-status.ok{ border-color:#86efac; background:#ecfdf3; color:#065f46; }
  .tf-status.error{ border-color:#fecaca; background:#fff1f2; color:#7f1d1d; }

  /* è¡¨æ ¼ï¼šé¿å…é‡å  + ä¸Šä¸‹å±…ä¸­ */
  .tf-table{
    table-layout: fixed;
  }
  .tf-table th,
  .tf-table td{
    vertical-align: middle !important;
  }
  .tf-table td{
    white-space: normal !important;     /* å…è®¸æ¢è¡Œï¼Œé¿å…æŒ¤å‹é‡å  */
    word-break: break-word;
  }
  .tf-ellipsis{
    display: -webkit-box;
    -webkit-line-clamp: 2;        /* description æœ€å¤šæ˜¾ç¤º 2 è¡Œï¼Œé¿å…è¡¨æ ¼è¿‡é«˜ */
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* è¯¦æƒ…æŒ‰é’®æ›´åƒäº§å“ */
  .btn-link{
    display:inline-block;
    padding:7px 10px;
    border-radius:10px;
    border:1px solid var(--border);
    background:#fff;
    color:#111;
    font-size:13px;
    line-height:1.2;
    text-decoration:none;
    white-space:nowrap;
  }
  .btn-link.primary{
    background: var(--primary);
    border-color: var(--primary);
    color:#fff;
  }
  .btn-link:hover{ background:#f5f5f5; text-decoration:none; }
  .btn-link.primary:hover{ background:#2559c7; border-color:#2559c7; }

  /* traffic é¡µè¡¨æ ¼å®¹å™¨ï¼šå¼ºåˆ¶ä¸é‡å ï¼ˆå…è®¸æ¨ªå‘æ»šåŠ¨åšå…œåº•ï¼‰ */
  .tf-table-wrap{ overflow-x:auto; }
</style>

<div class="card">
  <div class="tf-card-title">
    <div>
      <h3 style="margin:0;">åœ¨çº¿æŠ“åŒ…ï¼ˆdumpcapï¼‰</h3>
      <p class="tf-hint">
        ä»…åœ¨â€œåœæ­¢å¹¶å¯¼å…¥å…¥åº“â€æ—¶è¿›è¡Œè§£æä¸åˆ†æã€‚BPF ç¤ºä¾‹ï¼š<code>net 192.168.86.0/24</code> / <code>host 192.168.86.131</code> / <code>icmp</code>
      </p>
    </div>
  </div>

  <div class="tf-toolbar">
    <div class="tf-field wide">
      <label>ç½‘å¡ ifaceï¼ˆå¿…å¡«ï¼‰</label>
      <input id="tf-iface" type="text" placeholder="\Device\NPF_{FDE60FA6-C939-4031-9313-4FB8EF4F595B}">
      <div class="help">Windows ä¸‹å¸¸è§æ ¼å¼ï¼š<code>\Device\NPF_{...}</code>ï¼ˆä¾‹å¦‚ VMnet1ï¼‰ã€‚</div>
    </div>

    <div class="tf-field wide">
      <label>BPFï¼ˆå¯ç©ºï¼‰</label>
      <input id="tf-bpf" type="text" placeholder="net 192.168.86.0/24">
      <div class="help">å¯ç”¨äºå‡å°‘æŠ“åŒ…é‡ã€‚ç•™ç©ºè¡¨ç¤ºä¸è¿‡æ»¤ã€‚</div>
    </div>

    <div class="tf-field small">
      <label>host_nameï¼ˆå¯é€‰ï¼‰</label>
      <input id="tf-hostname" type="text" placeholder="VMnet1 / sensor-1">
      <div class="help">å…¥åº“æ ‡è®°é‡‡é›†ç‚¹ï¼Œä¸åœ¨åˆ—è¡¨å±•ç¤ºã€‚</div>
    </div>

    <div class="tf-field small">
      <label>åˆ†æå¼€å…³</label>
      <select id="tf-analysis">
        <option value="1" selected>å¯ç”¨ï¼ˆåœæ­¢åå¯¼å…¥å¹¶åˆ†æï¼‰</option>
        <option value="0">å…³é—­ï¼ˆåœæ­¢åä»…å¯¼å…¥ï¼‰</option>
      </select>
      <div class="help">å¯ç”¨åä¼šå†™å…¥ detections/anomalies ç­‰ç»“æ„åŒ–å­—æ®µã€‚</div>
    </div>

    <div class="tf-field wide">
      <label>dumpcap_pathï¼ˆå¯ç©ºï¼‰</label>
      <input id="tf-dumpcap" type="text" placeholder="é»˜è®¤: Config.DUMPCAP_PATH">
      <div class="help">é»˜è®¤ï¼š<code>{{ config.get('DUMPCAP_PATH', 'C:\\Program Files\\Wireshark\\dumpcap.exe') }}</code></div>
    </div>

    <div class="tf-actions" style="margin-left:auto;">
      <button class="btn" id="tf-start">å¼€å§‹æ•è·</button>
      <button class="btn btn-secondary" id="tf-stop" disabled>åœæ­¢å¹¶å¯¼å…¥å…¥åº“</button>
    </div>
  </div>

  <div id="tf-status" class="tf-status">çŠ¶æ€ï¼šunknown</div>
  <div id="tf-import" class="tf-status" style="display:none;"></div>
</div>

<div class="card" style="margin-top:14px;">
  <div class="tf-card-title">
    <div>
      <h3 style="margin:0;">ç¦»çº¿å¯¼å…¥ï¼ˆpcap / pcapngï¼‰</h3>
      <p class="tf-hint">ä¸Šä¼ åç«‹å³è§£æå¹¶å†™å…¥æ•°æ®åº“ï¼ˆNetworkTrafficï¼‰ã€‚</p>
    </div>
  </div>

  <div class="tf-toolbar">
    <div class="tf-field wide">
      <label>é€‰æ‹©æ–‡ä»¶</label>
      <input id="tf-file" type="file" accept=".pcap,.pcapng,.cap">
    </div>

    <div class="tf-field small">
      <label>host_nameï¼ˆå¯é€‰ï¼‰</label>
      <input id="tf-upload-hostname" type="text" placeholder="pcap_import">
    </div>

    <div class="tf-field small">
      <label>åˆ†æ</label>
      <select id="tf-upload-analysis">
        <option value="1" selected>å¯ç”¨</option>
        <option value="0">å…³é—­</option>
      </select>
    </div>

    <div class="tf-actions" style="margin-left:auto;">
      <button class="btn" id="tf-upload">ä¸Šä¼ å¹¶å¯¼å…¥</button>
    </div>
  </div>

  <div id="tf-upload-msg" class="tf-status">ç­‰å¾…ä¸Šä¼ ã€‚</div>
</div>

<div class="card" style="margin-top:14px;">
  <div class="tf-card-title">
    <div>
      <h3 style="margin:0;">æœ€è¿‘æµé‡</h3>
      <p class="tf-hint">æ”¯æŒæŒ‰ event_type ç­›é€‰ï¼šä»…å‘Šè­¦ / DNS éš§é“ / ICMP éš§é“ç­‰ã€‚</p>
    </div>
  </div>

  <form method="get" action="{{ url_for('traffic.index') }}" class="tf-toolbar">
    <div class="tf-field small">
      <label for="event_type">event_type ç­›é€‰</label>
      <select id="event_type" name="event_type">
        {% for opt in event_type_options %}
          <option value="{{ opt.value }}" {% if (event_type or '') == opt.value %}selected{% endif %}>{{ opt.label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="tf-actions">
      <button class="btn btn-secondary" type="submit">ç­›é€‰</button>
      <a class="btn-link" href="{{ url_for('traffic.index') }}">æ¸…é™¤</a>
    </div>
  </form>

  <p class="muted" style="margin-top:10px;">
    ğŸ“¦ æ€»æ•°ï¼š<b>{{ total }}</b> ï½œ ğŸ“„ ç¬¬ <b>{{ page }}</b> / <b>{{ total_pages }}</b> é¡µ
  </p>

  <div class="pager">
    {% if page > 1 %}
      <a class="btn-link" href="{{ url_for('traffic.index', page=page-1, event_type=event_type) }}">â¬… ä¸Šä¸€é¡µ</a>
    {% else %}
      <span class="btn-link" style="opacity:.55;">â¬… ä¸Šä¸€é¡µ</span>
    {% endif %}

    <span class="muted">æ¯é¡µï¼š{{ page_size }} æ¡</span>

    {% if page < total_pages %}
      <a class="btn-link" href="{{ url_for('traffic.index', page=page+1, event_type=event_type) }}">ä¸‹ä¸€é¡µ â¡</a>
    {% else %}
      <span class="btn-link" style="opacity:.55;">ä¸‹ä¸€é¡µ â¡</span>
    {% endif %}
  </div>

  <div class="tf-table-wrap" style="margin-top:12px;">
    <table class="tf-table">
      <thead>
        <tr>
          <th style="width:70px;">ID</th>
          <th style="width:180px;">create_time</th>
          <th style="width:170px;">timestamp</th>
          <th style="width:140px;">src_ip</th>
          <th style="width:140px;">dst_ip</th>
          <th style="width:90px;">protocol</th>
          <th style="width:170px;">event_type</th>
          <th>description</th>
          <th style="width:110px;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% if items and items|length %}
          {% for it in items %}
          <tr>
            <td>{{ it.id }}</td>
            <td>{{ it.create_time }}</td>
            <td>{{ it.timestamp }}</td>
            <td>{{ it.src_ip }}</td>
            <td>{{ it.dst_ip }}</td>
            <td>{{ it.protocol }}</td>
            <td>{{ it.event_type }}</td>
            <td><div class="tf-ellipsis" title="{{ it.description }}">{{ it.description }}</div></td>
            <td>
              <a class="btn-link primary" href="{{ url_for('traffic.detail_page', traffic_id=it.id, event_type=event_type) }}">è¯¦æƒ…</a>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="9">æš‚æ— æ•°æ®ã€‚ä½ å¯ä»¥å…ˆåœ¨çº¿æŠ“åŒ…æˆ–ä¸Šä¼  pcap å¯¼å…¥ã€‚</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
(function(){
  const API = {
    status: "/traffic/api/live/status",
    start: "/traffic/api/live/start",
    stop: "/traffic/api/live/stop",
    upload: "/traffic/api/upload"
  };

  const el = (id)=>document.getElementById(id);
  let busy = false;

  function setStatus(text, level){
    const s = el("tf-status");
    s.textContent = text;
    s.classList.remove("ok","error");
    if(level==="ok") s.classList.add("ok");
    if(level==="error") s.classList.add("error");
  }
  function showImport(text, level){
    const s = el("tf-import");
    s.style.display = "";
    s.textContent = text;
    s.classList.remove("ok","error");
    if(level==="ok") s.classList.add("ok");
    if(level==="error") s.classList.add("error");
  }
  function setUploadMsg(text, level){
    const s = el("tf-upload-msg");
    s.textContent = text;
    s.classList.remove("ok","error");
    if(level==="ok") s.classList.add("ok");
    if(level==="error") s.classList.add("error");
  }

  async function refreshStatus(){
    try{
      const resp = await fetch(API.status);
      const data = await resp.json();
      if(!data.ok){
        setStatus("çŠ¶æ€è·å–å¤±è´¥", "error");
        return;
      }

      const running = !!data.running;
      if(!busy){
        el("tf-start").disabled = running;
        el("tf-stop").disabled = !running;
      }

      const pcap = data.pcap_file || data.last_capture_file || "-";
      const err = data.last_error ? (" | last_error=" + data.last_error) : "";
      setStatus(`çŠ¶æ€ï¼š${running ? "RUNNING" : "STOPPED"} | pcap=${pcap}${err}`, running ? "ok" : "info");

      if(data.last_import){
        const r = data.last_import;
        showImport(`æœ€è¿‘ä¸€æ¬¡å¯¼å…¥ï¼šinserted=${r.inserted||0} skipped=${r.skipped||0} errors=${r.errors||0} total_packets=${r.total_packets||0}`, "ok");
      }
    }catch(e){
      setStatus("çŠ¶æ€è·å–å¼‚å¸¸ï¼š" + e, "error");
    }
  }

  async function startCapture(){
    if(busy) return;
    busy = true;

    const startBtn = el("tf-start");
    const stopBtn = el("tf-stop");
    const oldText = startBtn.textContent;
    startBtn.disabled = true;
    stopBtn.disabled = true;
    startBtn.textContent = "å¯åŠ¨ä¸­â€¦";

    try{
      const iface = (el("tf-iface").value||"").trim();
      const bpf = (el("tf-bpf").value||"").trim();
      const hostName = (el("tf-hostname").value||"").trim();
      const dumpcapPath = (el("tf-dumpcap").value||"").trim();

      if(!iface){
        alert("iface å¿…å¡«ï¼š\\Device\\NPF_{...}");
        return;
      }

      const payload = { iface, bpf: bpf || null, host_name: hostName || null };
      if(dumpcapPath) payload.dumpcap_path = dumpcapPath;

      const resp = await fetch(API.start, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if(!data.ok){
        alert("å¯åŠ¨å¤±è´¥ï¼š" + (data.error || "unknown"));
        return;
      }
    }finally{
      startBtn.textContent = oldText;
      busy = false;
      await refreshStatus();
    }
  }

  async function stopCapture(){
    if(busy) return;
    busy = true;

    const startBtn = el("tf-start");
    const stopBtn = el("tf-stop");
    const oldText = stopBtn.textContent;
    stopBtn.disabled = true;
    startBtn.disabled = true;
    stopBtn.textContent = "åœæ­¢å¹¶å¯¼å…¥ä¸­â€¦";

    try{
      const enableAnalysis = el("tf-analysis").value === "1";
      const hostName = (el("tf-hostname").value||"").trim();

      const resp = await fetch(API.stop, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ enable_analysis: enableAnalysis, host_name: hostName || null })
      });
      const data = await resp.json();
      if(!data.ok){
        alert("åœæ­¢/å¯¼å…¥å¤±è´¥ï¼š" + (data.error || "unknown"));
        return;
      }
      if(data.import){
        const r = data.import;
        showImport(`å¯¼å…¥å®Œæˆï¼šinserted=${r.inserted||0} skipped=${r.skipped||0} errors=${r.errors||0} total_packets=${r.total_packets||0}`, "ok");
      }
      setTimeout(()=>{ window.location.reload(); }, 600);
    }finally{
      stopBtn.textContent = oldText;
      busy = false;
      await refreshStatus();
    }
  }

  async function uploadFile(){
    if(busy) return;
    busy = true;

    const btn = el("tf-upload");
    const oldText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "ä¸Šä¼ ä¸­â€¦";

    try{
      const fileInput = el("tf-file");
      if(!fileInput.files || !fileInput.files.length){
        alert("è¯·é€‰æ‹© pcap/pcapng æ–‡ä»¶");
        return;
      }
      const file = fileInput.files[0];
      const hostName = (el("tf-upload-hostname").value||"").trim();
      const enableAnalysis = el("tf-upload-analysis").value === "1";

      const form = new FormData();
      form.append("file", file);
      form.append("host_name", hostName);
      form.append("enable_analysis", enableAnalysis ? "1" : "0");

      setUploadMsg("ä¸Šä¼ ä¸­å¹¶è§£æå…¥åº“â€¦", "info");

      const resp = await fetch(API.upload, {method:"POST", body: form});
      const data = await resp.json();
      if(!data.ok){
        setUploadMsg("ä¸Šä¼ å¤±è´¥ï¼š" + (data.error || "unknown"), "error");
        return;
      }
      const r = data.result || {};
      setUploadMsg(`å¯¼å…¥å®Œæˆï¼šinserted=${r.inserted||0} skipped=${r.skipped||0} errors=${r.errors||0} total_packets=${r.total_packets||0}`, "ok");
      setTimeout(()=>{ window.location.reload(); }, 600);
    }finally{
      btn.textContent = oldText;
      btn.disabled = false;
      busy = false;
    }
  }

  el("tf-start").addEventListener("click", startCapture);
  el("tf-stop").addEventListener("click", stopCapture);
  el("tf-upload").addEventListener("click", uploadFile);

  refreshStatus();
  setInterval(refreshStatus, 1500);
})();
</script>

{% endblock %}