{% extends "layout.html" %}

{% block title %}æµé‡åˆ†æ - æ”»å‡»æº¯æºåˆ†æç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="page-head">
  <div class="page-head-row">
    <div>
      <h2>ç½‘ç»œæµé‡åˆ†æ</h2>
      <p class="muted" style="margin:0;">
        åœ¨çº¿æŠ“åŒ…æ”¯æŒ Npcap/WinPcap ç½‘å¡è®¾å¤‡åï¼ˆWindows ä¸‹é€šå¸¸æ˜¯ <code>\Device\NPF_{...}</code>ï¼‰ã€‚
        ç¦»çº¿å¯¼å…¥æ”¯æŒ <code>.pcap / .pcapng</code>ï¼Œå…¥åº“åˆ° <code>dbo.NetworkTraffic</code>ã€‚
      </p>
    </div>
  </div>
</div>

<style>
  /* åªé’ˆå¯¹ traffic é¡µé¢åšä¸€ç‚¹å±€éƒ¨ä¼˜åŒ–ï¼Œé¿å…å½±å“å…¨å±€ */
  .tf-card-title{ display:flex; align-items:baseline; gap:10px; margin-bottom:10px; }
  .tf-card-title h3{ margin:0; }
  .tf-hint{ font-size:12px; color: var(--muted); line-height:1.55; margin:0; }

  .tf-form{
    display:grid;
    grid-template-columns: 1.4fr 1fr 0.8fr 140px 160px auto;
    gap:12px;
    align-items:end;
  }
  @media (max-width: 1100px){
    .tf-form{ grid-template-columns: 1fr 1fr; }
  }

  .tf-field{ display:flex; flex-direction:column; gap:6px; }
  .tf-field label{ font-size:12px; color:#4b5563; font-weight:700; }
  .tf-field input, .tf-field select{
    border:1px solid var(--border);
    border-radius:10px;
    padding:9px 10px;
    font-size:14px;
    background:#fff;
  }

  .tf-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

  .tf-status{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--border);
    background:#f8fafc;
    font-size:13px;
    color:#0f172a;
    margin-top:10px;
    line-height: 1.5;
    word-break: break-word;
  }
  .tf-status.ok{ border-color:#86efac; background:#ecfdf3; color:#065f46; }
  .tf-status.error{ border-color:#fecaca; background:#fff1f2; color:#7f1d1d; }

  /* æŒ‰é’®â€œå˜æš—â€åé¦ˆ */
  .btn[disabled]{ opacity:.55; cursor:not-allowed; filter: grayscale(0.2); }

  /* åˆ—è¡¨å›ºå®šå¸ƒå±€ï¼Œå°½é‡ä¸å·¦å³æ»šåŠ¨ */
  .tf-table{
    table-layout: fixed;
  }
  .tf-table th, .tf-table td{
    white-space: normal;     /* å…è®¸æ¢è¡Œ */
    overflow: hidden;
    text-overflow: ellipsis; /* å¤ªé•¿æˆªæ–­ */
    vertical-align: top;
  }
</style>

<div class="card">
  <div class="tf-card-title">
    <h3>åœ¨çº¿æŠ“åŒ…</h3>
    <p class="tf-hint">
      å»ºè®®ç®¡ç†å‘˜æƒé™è¿è¡Œ Flaskã€‚ç¤ºä¾‹ ifaceï¼š<code>\Device\NPF_{FDE60FA6-C939-4031-9313-4FB8EF4F595B}</code>ï¼ˆVMnet1ï¼‰ã€‚
      BPF ç¤ºä¾‹ï¼š<code>net 192.168.86.0/24</code> / <code>port 53</code> / <code>host 192.168.86.131</code>
    </p>
  </div>

  <div class="tf-form">
    <div class="tf-field">
      <label for="tf-iface">ç½‘å¡ ifaceï¼ˆå¿…å¡«ï¼‰</label>
      <input id="tf-iface" type="text" placeholder="\Device\NPF_{...}">
    </div>

    <div class="tf-field">
      <label for="tf-bpf">è¿‡æ»¤è§„åˆ™ BPFï¼ˆå¯ç©ºï¼‰</label>
      <input id="tf-bpf" type="text" placeholder="net 192.168.86.0/24">
    </div>

    <div class="tf-field">
      <label for="tf-hostname">é‡‡é›†ç‚¹ host_nameï¼ˆå¯é€‰ï¼‰</label>
      <input id="tf-hostname" type="text" placeholder="VMnet1 / sensor-1">
    </div>

    <div class="tf-field">
      <label for="tf-flush">å†™åº“ flush(s)</label>
      <select id="tf-flush">
        <option value="0.5">0.5</option>
        <option value="1" selected>1</option>
        <option value="2">2</option>
        <option value="5">5</option>
      </select>
    </div>

    <div class="tf-field">
      <label for="tf-analysis">åˆ†æå¼€å…³</label>
      <select id="tf-analysis">
        <option value="1" selected>å¯ç”¨ï¼ˆä¼šè¯/å¼‚å¸¸/éšè”½ä¿¡é“ï¼‰</option>
        <option value="0">å…³é—­ï¼ˆä»…å…¥åº“ï¼‰</option>
      </select>
    </div>

    <div class="tf-actions">
      <button class="btn" id="tf-start">å¼€å§‹æ•è·</button>
      <button class="btn btn-secondary" id="tf-stop" disabled>åœæ­¢æ•è·</button>
    </div>
  </div>

  <div id="tf-status" class="tf-status">çŠ¶æ€ï¼šunknown</div>
</div>

<div class="card" style="margin-top:14px;">
  <div class="tf-card-title">
    <h3>ç¦»çº¿å¯¼å…¥ï¼ˆpcap / pcapngï¼‰</h3>
    <p class="tf-hint">
      ä¸Šä¼ åä¼šè§£æå¹¶å†™å…¥æ•°æ®åº“ã€‚é€‚åˆå¿«é€Ÿé€ æ•°æˆ–ç¦»çº¿å¤ç°ã€‚
    </p>
  </div>

  <div class="tf-form" style="grid-template-columns: 1.6fr 0.8fr 200px auto;">
    <div class="tf-field">
      <label for="tf-file">é€‰æ‹©æ–‡ä»¶</label>
      <input id="tf-file" type="file" accept=".pcap,.pcapng,.cap">
    </div>

    <div class="tf-field">
      <label for="tf-upload-hostname">host_nameï¼ˆå¯é€‰ï¼‰</label>
      <input id="tf-upload-hostname" type="text" placeholder="pcap_import">
    </div>

    <div class="tf-field">
      <label for="tf-upload-analysis">åˆ†æå¼€å…³</label>
      <select id="tf-upload-analysis">
        <option value="1" selected>å¯ç”¨</option>
        <option value="0">å…³é—­</option>
      </select>
    </div>

    <div class="tf-actions" style="justify-content:flex-end;">
      <button class="btn" id="tf-upload">ä¸Šä¼ å¹¶å¯¼å…¥</button>
    </div>
  </div>

  <div id="tf-upload-msg" class="tf-status" style="margin-top:10px;">ç­‰å¾…ä¸Šä¼ ã€‚</div>
</div>

<div class="card" style="margin-top:14px;">
  <div class="page-head-row" style="margin-bottom:10px;">
    <div>
      <h3 style="margin:0;">æœ€è¿‘æµé‡</h3>
      <p class="tf-hint" style="margin-top:6px;">
        åˆ—è¡¨å›ºå®šå¸ƒå±€ä¸å·¦å³æ»šåŠ¨ï¼›ç‚¹å‡»â€œè¯¦æƒ…â€æŸ¥çœ‹ result/contentã€‚
      </p>
    </div>
    <div class="tf-actions">
      <a class="btn btn-secondary" href="{{ url_for('traffic.index') }}">åˆ·æ–°åˆ—è¡¨</a>
    </div>
  </div>

  <div class="muted" style="margin-bottom:10px;">
    ğŸ“¦ æ€»æ•°ï¼š<b>{{ total }}</b> ï½œ ğŸ“„ ç¬¬ <b>{{ page }}</b> / <b>{{ total_pages }}</b> é¡µ
  </div>

  <div class="pager" style="justify-content:space-between;">
    <div>
      {% if page > 1 %}
        <a class="btn btn-secondary" href="{{ url_for('traffic.index', page=page-1) }}">â¬… ä¸Šä¸€é¡µ</a>
      {% else %}
        <button class="btn btn-secondary" disabled>â¬… ä¸Šä¸€é¡µ</button>
      {% endif %}
    </div>

    <div class="muted">æ¯é¡µï¼š{{ page_size }} æ¡</div>

    <div>
      {% if page < total_pages %}
        <a class="btn btn-secondary" href="{{ url_for('traffic.index', page=page+1) }}">ä¸‹ä¸€é¡µ â¡</a>
      {% else %}
        <button class="btn btn-secondary" disabled>ä¸‹ä¸€é¡µ â¡</button>
      {% endif %}
    </div>
  </div>

  <div class="table-wrap" style="margin-top:12px;">
    <table class="tf-table">
      <thead>
        <tr>
          <th style="width:70px;">ID</th>
          <th style="width:180px;">create_time</th>
          <th style="width:170px;">timestamp</th>
          <th style="width:140px;">src_ip</th>
          <th style="width:140px;">dst_ip</th>
          <th style="width:90px;">protocol</th>
          <th style="width:170px;">event_type</th>
          <th>description</th>
          <th style="width:90px;">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        {% if items and items|length %}
          {% for it in items %}
          <tr>
            <td>{{ it.id }}</td>
            <td>{{ it.create_time }}</td>
            <td>{{ it.timestamp }}</td>
            <td>{{ it.src_ip }}</td>
            <td>{{ it.dst_ip }}</td>
            <td>{{ it.protocol }}</td>
            <td>{{ it.event_type }}</td>
            <td>{{ it.description }}</td>
            <td>
              <a href="{{ url_for('traffic.detail_page', traffic_id=it.id) }}">è¯¦æƒ…</a>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="9">æš‚æ— æ•°æ®ã€‚ä½ å¯ä»¥å…ˆåœ¨çº¿æŠ“åŒ…æˆ–ä¸Šä¼  pcap å¯¼å…¥ã€‚</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
(function(){
  const API = {
    status: "/traffic/api/live/status",
    start: "/traffic/api/live/start",
    stop: "/traffic/api/live/stop",
    upload: "/traffic/api/upload"
  };

  const el = (id)=>document.getElementById(id);

  let pollTimer = null;
  let busy = false; // é˜²é‡å¤ç‚¹å‡»

  function setStatus(text, level){
    const s = el("tf-status");
    s.textContent = text;
    s.classList.remove("ok","error");
    if(level==="ok") s.classList.add("ok");
    if(level==="error") s.classList.add("error");
  }

  function setUploadMsg(text, level){
    const s = el("tf-upload-msg");
    s.textContent = text;
    s.classList.remove("ok","error");
    if(level==="ok") s.classList.add("ok");
    if(level==="error") s.classList.add("error");
  }

  async function refreshStatus(){
    try{
      const resp = await fetch(API.status);
      const data = await resp.json();
      if(!data.ok){
        setStatus("çŠ¶æ€è·å–å¤±è´¥", "error");
        return;
      }

      const running = !!data.running;
      const c = data.counters || {};

      // æ³¨æ„ï¼šbusy æ—¶ä¸è¦è®©æŒ‰é’®çŠ¶æ€è¢«è½®è¯¢æ‰“æ–­ï¼ˆé¿å…ç”¨æˆ·ç‚¹äº† start ç«‹åˆ»è¢« status æ”¹å›å»ï¼‰
      if(!busy){
        el("tf-start").disabled = running;
        el("tf-stop").disabled = !running;
      }

      setStatus(
        `çŠ¶æ€ï¼š${running ? "RUNNING" : "STOPPED"} ï½œ inserted=${c.inserted||0} skipped=${c.skipped||0} errors=${c.errors||0} dropped=${c.dropped||0}` +
        (running ? ` ï½œ iface=${data.iface||"-"} ï½œ bpf=${data.bpf||"-"}` : ""),
        running ? "ok" : "info"
      );
    }catch(e){
      setStatus("çŠ¶æ€è·å–å¼‚å¸¸ï¼š" + e, "error");
    }
  }

  async function startCapture(){
    if(busy) return;
    busy = true;

    const startBtn = el("tf-start");
    const stopBtn = el("tf-stop");

    // ç«‹å³åé¦ˆï¼šæŒ‰é’®å˜æš— + æ–‡æ¡ˆå˜åŒ–
    startBtn.disabled = true;
    stopBtn.disabled = true;
    const oldText = startBtn.textContent;
    startBtn.textContent = "å¯åŠ¨ä¸­â€¦";

    try{
      const iface = (el("tf-iface").value || "").trim();
      const bpf = (el("tf-bpf").value || "").trim();
      const hostName = (el("tf-hostname").value || "").trim();
      const flush = parseFloat(el("tf-flush").value || "1");
      const enableAnalysis = el("tf-analysis").value === "1";

      if(!iface){
        alert("iface å¿…å¡«ï¼šè¯·ç²˜è´´ \\Device\\NPF_{...}");
        return;
      }

      const payload = {
        iface: iface,
        bpf: bpf || null,
        host_name: hostName || null,
        flush_interval_sec: flush,
        enable_analysis: enableAnalysis
      };

      const resp = await fetch(API.start, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if(!data.ok){
        alert("å¯åŠ¨å¤±è´¥ï¼š" + (data.error || "unknown"));
        return;
      }
    }finally{
      startBtn.textContent = oldText;
      busy = false;
      await refreshStatus();
    }
  }

  async function stopCapture(){
    if(busy) return;
    busy = true;

    const startBtn = el("tf-start");
    const stopBtn = el("tf-stop");

    stopBtn.disabled = true;
    startBtn.disabled = true;
    const oldText = stopBtn.textContent;
    stopBtn.textContent = "åœæ­¢ä¸­â€¦";

    try{
      const resp = await fetch(API.stop, {method:"POST"});
      const data = await resp.json();
      if(!data.ok){
        alert("åœæ­¢å¤±è´¥ï¼š" + (data.error || "unknown"));
        return;
      }
    }finally{
      stopBtn.textContent = oldText;
      busy = false;
      await refreshStatus();
    }
  }

  async function uploadFile(){
    if(busy) return;
    busy = true;

    const btn = el("tf-upload");
    btn.disabled = true;
    const oldText = btn.textContent;
    btn.textContent = "ä¸Šä¼ ä¸­â€¦";

    try{
      const fileInput = el("tf-file");
      if(!fileInput.files || !fileInput.files.length){
        alert("è¯·é€‰æ‹© pcap/pcapng æ–‡ä»¶");
        return;
      }
      const file = fileInput.files[0];
      const hostName = (el("tf-upload-hostname").value || "").trim();
      const enableAnalysis = el("tf-upload-analysis").value === "1";

      const form = new FormData();
      form.append("file", file);
      form.append("host_name", hostName);
      form.append("enable_analysis", enableAnalysis ? "1" : "0");

      setUploadMsg("ä¸Šä¼ ä¸­å¹¶è§£æå…¥åº“â€¦", "info");

      const resp = await fetch(API.upload, {method:"POST", body: form});
      const data = await resp.json();
      if(!data.ok){
        setUploadMsg("ä¸Šä¼ å¤±è´¥ï¼š" + (data.error || "unknown"), "error");
        return;
      }
      const r = data.result || {};
      setUploadMsg(`å¯¼å…¥å®Œæˆï¼šinserted=${r.inserted||0} skipped=${r.skipped||0} errors=${r.errors||0} total_packets=${r.total_packets||0}`, "ok");

      // å¯¼å…¥å®Œæˆååˆ·æ–°é¡µé¢åˆ—è¡¨ï¼ˆæœ€ç®€å•ï¼Œå’Œ logs ç»Ÿä¸€é£æ ¼ï¼‰
      setTimeout(()=>{ window.location.href = "{{ url_for('traffic.index') }}"; }, 600);
    }finally{
      btn.textContent = oldText;
      btn.disabled = false;
      busy = false;
    }
  }

  el("tf-start").addEventListener("click", startCapture);
  el("tf-stop").addEventListener("click", stopCapture);
  el("tf-upload").addEventListener("click", uploadFile);

  refreshStatus();
  pollTimer = setInterval(refreshStatus, 1000);
})();
</script>
{% endblock %}