{% extends "layout.html" %}

{% block title %}流量分析 - 攻击溯源分析系统{% endblock %}

{% block content %}
<h2>网络流量分析</h2>
<p class="muted">
  支持：在线抓包（Start/Stop，实时入库） / 上传 pcap/pcapng 导入入库 / 最近流量列表。
</p>

<div class="card">
  <h3>在线抓包</h3>

  <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
    <div class="lt-field" style="min-width:420px;">
      <label>iface（必填，建议直接粘贴 NPF 名称）</label>
      <input id="tf-iface" type="text" placeholder="\Device\NPF_{FDE60FA6-C939-4031-9313-4FB8EF4F595B}">
    </div>

    <div class="lt-field" style="min-width:360px;">
      <label>BPF（可空，如：net 192.168.86.0/24 或 port 53）</label>
      <input id="tf-bpf" type="text" placeholder="net 192.168.86.0/24">
    </div>

    <div class="lt-field" style="min-width:200px;">
      <label>host_name（采集点标识）</label>
      <input id="tf-hostname" type="text" placeholder="VMnet1 / sensor-1">
    </div>

    <div class="lt-field" style="min-width:140px;">
      <label>flush(s)</label>
      <select id="tf-flush">
        <option value="0.5">0.5</option>
        <option value="1" selected>1</option>
        <option value="2">2</option>
        <option value="5">5</option>
      </select>
    </div>

    <div class="lt-field" style="min-width:160px;">
      <label>analysis</label>
      <select id="tf-analysis">
        <option value="1" selected>enable</option>
        <option value="0">disable</option>
      </select>
    </div>

    <div style="display:flex; gap:10px; align-items:center;">
      <button class="btn" id="tf-start">开始捕获</button>
      <button class="btn btn-secondary" id="tf-stop" disabled>停止捕获</button>
    </div>
  </div>

  <div style="margin-top:12px;">
    <div id="tf-status" class="lt-status">状态：unknown</div>
  </div>
</div>

<div class="card" style="margin-top:14px;">
  <h3>离线上传（pcap/pcapng）导入入库</h3>

  <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
    <div class="lt-field" style="min-width:420px;">
      <label>文件</label>
      <input id="tf-file" type="file" accept=".pcap,.pcapng,.cap">
    </div>

    <div class="lt-field" style="min-width:220px;">
      <label>host_name（可选）</label>
      <input id="tf-upload-hostname" type="text" placeholder="pcap_import">
    </div>

    <div class="lt-field" style="min-width:160px;">
      <label>analysis</label>
      <select id="tf-upload-analysis">
        <option value="1" selected>enable</option>
        <option value="0">disable</option>
      </select>
    </div>

    <div>
      <button class="btn" id="tf-upload">上传并导入</button>
    </div>
  </div>

  <div style="margin-top:12px;">
    <div id="tf-upload-msg" class="lt-status">等待上传。</div>
  </div>
</div>

<div class="card" style="margin-top:14px;">
  <h3>最近流量（分页）</h3>

  <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
    <div class="lt-field" style="min-width:220px;">
      <label>host_name 筛选（可空）</label>
      <input id="tf-filter-hostname" type="text" placeholder="VMnet1">
    </div>
    <div class="lt-field" style="min-width:140px;">
      <label>page_size</label>
      <select id="tf-pagesize">
        <option value="10">10</option>
        <option value="20" selected>20</option>
        <option value="50">50</option>
      </select>
    </div>
    <div>
      <button class="btn" id="tf-refresh">刷新</button>
    </div>
  </div>

  <div class="table-wrap" style="margin-top:12px;">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>create_time</th>
          <th>host_name</th>
          <th>timestamp</th>
          <th>src_ip</th>
          <th>dst_ip</th>
          <th>protocol</th>
          <th>event_type</th>
          <th>description</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="tf-tbody">
        <tr><td colspan="10">暂无数据。</td></tr>
      </tbody>
    </table>
  </div>

  <div class="pager">
    <button class="btn" id="tf-prev">上一页</button>
    <span id="tf-page">1</span>
    <button class="btn" id="tf-next">下一页</button>
  </div>
</div>

<script>
(function(){
  const API = {
    status: "/traffic/api/live/status",
    start: "/traffic/api/live/start",
    stop: "/traffic/api/live/stop",
    upload: "/traffic/api/upload",
    recent: "/traffic/api/recent",
    detail: "/traffic/api/detail/"
  };

  const el = (id)=>document.getElementById(id);

  let pollTimer = null;
  let page = 1;
  let total = 0;

  function setStatus(text, level){
    const s = el("tf-status");
    s.textContent = text;
    s.classList.remove("ok","error");
    if(level==="ok") s.classList.add("ok");
    if(level==="error") s.classList.add("error");
  }

  async function refreshStatus(){
    try{
      const resp = await fetch(API.status);
      const data = await resp.json();
      if(!data.ok){ setStatus("状态获取失败", "error"); return; }

      const running = !!data.running;
      el("tf-start").disabled = running;
      el("tf-stop").disabled = !running;

      const c = data.counters || {};
      setStatus(
        `状态：${running ? "running" : "stopped"} | inserted=${c.inserted||0} skipped=${c.skipped||0} errors=${c.errors||0} dropped=${c.dropped||0} | iface=${data.iface||"-"} | bpf=${data.bpf||"-"} | host_name=${data.host_name||"-"}`,
        running ? "ok" : "info"
      );
    }catch(e){
      setStatus("状态获取异常：" + e, "error");
    }
  }

  async function startCapture(){
    const iface = (el("tf-iface").value || "").trim();
    const bpf = (el("tf-bpf").value || "").trim();
    const hostName = (el("tf-hostname").value || "").trim();
    const flush = parseFloat(el("tf-flush").value || "1");
    const enableAnalysis = el("tf-analysis").value === "1";

    if(!iface){
      alert("iface 必填：请粘贴 \\Device\\NPF_{...}");
      return;
    }

    const payload = {
      iface: iface,
      bpf: bpf || null,
      host_name: hostName || null,
      flush_interval_sec: flush,
      enable_analysis: enableAnalysis
    };

    const resp = await fetch(API.start, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await resp.json();
    if(!data.ok){
      alert("启动失败：" + (data.error || "unknown"));
      return;
    }
    await refreshStatus();
  }

  async function stopCapture(){
    const resp = await fetch(API.stop, {method:"POST"});
    const data = await resp.json();
    if(!data.ok){
      alert("停止失败：" + (data.error || "unknown"));
      return;
    }
    await refreshStatus();
  }

  function setUploadMsg(text, level){
    const s = el("tf-upload-msg");
    s.textContent = text;
    s.classList.remove("ok","error");
    if(level==="ok") s.classList.add("ok");
    if(level==="error") s.classList.add("error");
  }

  async function uploadFile(){
    const fileInput = el("tf-file");
    if(!fileInput.files || !fileInput.files.length){
      alert("请选择 pcap/pcapng 文件");
      return;
    }
    const file = fileInput.files[0];
    const hostName = (el("tf-upload-hostname").value || "").trim();
    const enableAnalysis = el("tf-upload-analysis").value === "1";

    const form = new FormData();
    form.append("file", file);
    form.append("host_name", hostName);
    form.append("enable_analysis", enableAnalysis ? "1" : "0");

    setUploadMsg("上传中...", "info");

    const resp = await fetch(API.upload, {method:"POST", body: form});
    const data = await resp.json();
    if(!data.ok){
      setUploadMsg("上传失败：" + (data.error || "unknown"), "error");
      return;
    }
    const r = data.result || {};
    setUploadMsg(`导入完成：inserted=${r.inserted||0} skipped=${r.skipped||0} errors=${r.errors||0} total_packets=${r.total_packets||0}`, "ok");
    await loadRecent(true);
  }

  async function loadRecent(reset){
    if(reset) page = 1;
    const hostName = (el("tf-filter-hostname").value || "").trim();
    const pageSize = parseInt(el("tf-pagesize").value || "20", 10);

    const url = new URL(API.recent, window.location.origin);
    url.searchParams.set("page", page);
    url.searchParams.set("page_size", pageSize);
    if(hostName) url.searchParams.set("host_name", hostName);

    const resp = await fetch(url.toString());
    const data = await resp.json();
    if(!data.ok){
      el("tf-tbody").innerHTML = `<tr><td colspan="10">加载失败</td></tr>`;
      return;
    }
    total = data.total || 0;
    el("tf-page").textContent = String(page);

    const items = data.items || [];
    if(!items.length){
      el("tf-tbody").innerHTML = `<tr><td colspan="10">暂无数据</td></tr>`;
      return;
    }

    el("tf-tbody").innerHTML = items.map(it => {
      const desc = (it.description || "").toString();
      const safeDesc = desc.length > 80 ? (desc.slice(0,80) + "...") : desc;
      return `
        <tr>
          <td>${it.id}</td>
          <td>${it.create_time || ""}</td>
          <td>${it.host_name || ""}</td>
          <td>${it.timestamp || ""}</td>
          <td>${it.src_ip || ""}</td>
          <td>${it.dst_ip || ""}</td>
          <td>${it.protocol || ""}</td>
          <td>${it.event_type || ""}</td>
          <td title="${desc.replaceAll('"','&quot;')}">${safeDesc}</td>
          <td><button class="btn" data-id="${it.id}">详情</button></td>
        </tr>
      `;
    }).join("");

    el("tf-tbody").querySelectorAll("button[data-id]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-id");
        const resp2 = await fetch(API.detail + encodeURIComponent(id));
        const d2 = await resp2.json();
        if(!d2.ok){
          alert("详情获取失败");
          return;
        }
        alert(JSON.stringify(d2.row.result, null, 2));
      });
    });
  }

  el("tf-start").addEventListener("click", startCapture);
  el("tf-stop").addEventListener("click", stopCapture);
  el("tf-upload").addEventListener("click", uploadFile);
  el("tf-refresh").addEventListener("click", ()=>loadRecent(true));
  el("tf-prev").addEventListener("click", ()=>{ if(page>1){ page--; loadRecent(false);} });
  el("tf-next").addEventListener("click", ()=>{ page++; loadRecent(false); });

  refreshStatus();
  loadRecent(true);
  pollTimer = setInterval(refreshStatus, 1000);
})();
</script>
{% endblock %}