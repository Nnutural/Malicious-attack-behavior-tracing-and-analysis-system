## SecurityTraceDB 数据库构建

### 初始建库：

```

```



### 主机日志表：HostLogs

---

| id   | result               | content            | create_time        | event_hash | host_name           |
| ---- | -------------------- | ------------------ | ------------------ | ---------- | ------------------- |
|      | 主机日志处理后的结果 | 主机日志(完整原文) | 主机日志获取的时间 | 去重hash   | 主机名/ComputerName |

- result/content 均为 NVARCHAR(MAX)

- **加了一个 event_hash VARCHAR(64) NULL ** 字段用于去重

	* 直接在SQL server上加就行

- 并加了唯一索引：（下面代码在加字段后执行）

	* ```sql
		CREATE UNIQUE INDEX UX_HostLogs_event_hash
		ON dbo.HostLogs(event_hash)
		WHERE event_hash IS NOT NULL;
		```

- **加了一个主机名的字段：host_name nvarchar(255)**

	* ```sql
		ALTER TABLE dbo.HostLogs
		ADD host_name NVARCHAR(255) NULL;
		
		CREATE INDEX IX_HostLogs_host_name
		ON dbo.HostLogs(host_name);
		```

		

### 主机行为表：HostBehaviors

---

| id  | result     | content | create_time |
| --- | ---------- | ------- | ----------- |
|     | 主机行为处理后的结果 | 主机行为内容  | 主机行为获取的时间   |

更新一下主机行为表：

| 字段名         | 类型                                      | 说明                                                         |
| -------------- | ----------------------------------------- | ------------------------------------------------------------ |
| id             | INT IDENTITY(1,1) PRIMARY KEY             | 主键                                                         |
| result         | NVARCHAR(MAX) NOT NULL                    | 主机行为处理后的结果（标准化事件 dict JSON 字符串，接口文档 `host_behavior` schema） |
| content        | NVARCHAR(MAX) NULL                        | 原始行为内容（Linux: Falco 原始 JSON 行；Windows: Sysmon XML / raw_data） |
| create_time    | DATETIME2 NOT NULL DEFAULT(sysdatetime()) | 入库时间                                                     |
| event_hash     | VARCHAR(64) NULL                          | 去重用哈希（sha256(result_sorted_json)）                     |
| host_name      | NVARCHAR(255) NULL                        | 主机名（Windows ComputerName / Linux hostname，可用于筛选）  |
| event_time_utc | DATETIME2 NULL                            | 从 result.timestamp 解析出来的 UTC 时间（用于时间线/窗口查询） |

行为表的建表脚本：（先把之前的表删掉）

```sql
-- 选择你的库
-- USE SecurityTraceDB;
-- GO

IF OBJECT_ID('dbo.HostBehaviors', 'U') IS NULL
BEGIN
    CREATE TABLE dbo.HostBehaviors (
        id INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
        result NVARCHAR(MAX) NOT NULL,          -- 标准化事件 dict 的 JSON 字符串
        content NVARCHAR(MAX) NULL,             -- 原始采集内容（Linux: falco 原始行；Windows: sysmon XML）
        create_time DATETIME2 NOT NULL CONSTRAINT DF_HostBehaviors_create_time DEFAULT (sysdatetime()),
        event_hash VARCHAR(64) NULL,            -- sha256(result_sorted_json) 去重
        host_name NVARCHAR(255) NULL,           -- 主机名/ComputerName/hostname
        event_time_utc DATETIME2 NULL           -- 从 result.timestamp 解析
    );
END
GO

-- 唯一索引（只对非 NULL 生效）
IF NOT EXISTS (
    SELECT 1 FROM sys.indexes 
    WHERE name = 'UX_HostBehaviors_event_hash' 
      AND object_id = OBJECT_ID('dbo.HostBehaviors')
)
BEGIN
    CREATE UNIQUE INDEX UX_HostBehaviors_event_hash
    ON dbo.HostBehaviors(event_hash)
    WHERE event_hash IS NOT NULL;
END
GO

-- create_time 索引（用于分页/按入库时间查）
IF NOT EXISTS (
    SELECT 1 FROM sys.indexes 
    WHERE name = 'IX_HostBehaviors_create_time' 
      AND object_id = OBJECT_ID('dbo.HostBehaviors')
)
BEGIN
    CREATE INDEX IX_HostBehaviors_create_time
    ON dbo.HostBehaviors(create_time DESC);
END
GO

-- event_time_utc 索引（用于按事件时间查）
IF NOT EXISTS (
    SELECT 1 FROM sys.indexes 
    WHERE name = 'IX_HostBehaviors_event_time_utc' 
      AND object_id = OBJECT_ID('dbo.HostBehaviors')
)
BEGIN
    CREATE INDEX IX_HostBehaviors_event_time_utc
    ON dbo.HostBehaviors(event_time_utc DESC);
END
GO

-- host_name 索引（用于筛选）
IF NOT EXISTS (
    SELECT 1 FROM sys.indexes 
    WHERE name = 'IX_HostBehaviors_host_name' 
      AND object_id = OBJECT_ID('dbo.HostBehaviors')
)
BEGIN
    CREATE INDEX IX_HostBehaviors_host_name
    ON dbo.HostBehaviors(host_name);
END
GO
```



### 网络流量表：NetworkTraffic

---

| id  | result     | content   | create_time |
| --- | ---------- | --------- | ----------- |
|     | 网络流量处理后的结果 | 捕获网络流量的内容 | 网络流量获取的时间   |

这里的主机日志、主机行为内容、捕获网络流量的内容应该都是具体捕获到的字符串信息，三个表的处理结果都是字符串，但内容都是字典，就是“日志、行为、流量收集的接口文档.md”需要的三种接口里面的字典

* 增加字段的脚本：

* ```sql
	-- NetworkTraffic 表升级脚本（v2）
	-- 增加：event_hash / host_name / event_time_utc（可选，但强烈建议，方便按事件时间查询）
	-- 并添加索引：去重唯一索引 + host_name + event_time_utc + create_time
	
	-- 1) 确保表存在（如果你已建过，会跳过）
	IF OBJECT_ID('dbo.NetworkTraffic', 'U') IS NULL
	BEGIN
	    CREATE TABLE dbo.NetworkTraffic (
	        id INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
	        result NVARCHAR(MAX) NOT NULL,
	        content NVARCHAR(MAX) NULL,
	        create_time DATETIME2 NOT NULL CONSTRAINT DF_NetworkTraffic_create_time DEFAULT (sysdatetime())
	    );
	END
	GO
	
	-- 2) 加字段：event_hash
	IF COL_LENGTH('dbo.NetworkTraffic', 'event_hash') IS NULL
	BEGIN
	    ALTER TABLE dbo.NetworkTraffic
	    ADD event_hash VARCHAR(64) NULL;
	END
	GO
	
	-- 3) 加字段：host_name
	IF COL_LENGTH('dbo.NetworkTraffic', 'host_name') IS NULL
	BEGIN
	    ALTER TABLE dbo.NetworkTraffic
	    ADD host_name NVARCHAR(255) NULL;
	END
	GO
	
	-- 4) （推荐）加字段：event_time_utc，从 result.timestamp 解析（用于时间线/窗口查询）
	IF COL_LENGTH('dbo.NetworkTraffic', 'event_time_utc') IS NULL
	BEGIN
	    ALTER TABLE dbo.NetworkTraffic
	    ADD event_time_utc DATETIME2 NULL;
	END
	GO
	
	-- 5) 唯一索引：event_hash 去重（只对非 NULL 生效）
	IF NOT EXISTS (
	    SELECT 1 FROM sys.indexes
	    WHERE name = 'UX_NetworkTraffic_event_hash'
	      AND object_id = OBJECT_ID('dbo.NetworkTraffic')
	)
	BEGIN
	    CREATE UNIQUE INDEX UX_NetworkTraffic_event_hash
	    ON dbo.NetworkTraffic(event_hash)
	    WHERE event_hash IS NOT NULL;
	END
	GO
	
	-- 6) create_time 索引（用于分页/按入库时间查）
	IF NOT EXISTS (
	    SELECT 1 FROM sys.indexes
	    WHERE name = 'IX_NetworkTraffic_create_time'
	      AND object_id = OBJECT_ID('dbo.NetworkTraffic')
	)
	BEGIN
	    CREATE INDEX IX_NetworkTraffic_create_time
	    ON dbo.NetworkTraffic(create_time DESC);
	END
	GO
	
	-- 7) host_name 索引（用于筛选）
	IF NOT EXISTS (
	    SELECT 1 FROM sys.indexes
	    WHERE name = 'IX_NetworkTraffic_host_name'
	      AND object_id = OBJECT_ID('dbo.NetworkTraffic')
	)
	BEGIN
	    CREATE INDEX IX_NetworkTraffic_host_name
	    ON dbo.NetworkTraffic(host_name);
	END
	GO
	
	-- 8) event_time_utc 索引（用于按事件时间查）
	IF NOT EXISTS (
	    SELECT 1 FROM sys.indexes
	    WHERE name = 'IX_NetworkTraffic_event_time_utc'
	      AND object_id = OBJECT_ID('dbo.NetworkTraffic')
	)
	BEGIN
	    CREATE INDEX IX_NetworkTraffic_event_time_utc
	    ON dbo.NetworkTraffic(event_time_utc DESC);
	END
	GO
	```

	

### 攻击结果表：AttackReports：

---

建表脚本：

```sql
-- 在 SecurityTraceDB 数据库中执行
CREATE TABLE AttackReports (
    id INT IDENTITY(1,1) PRIMARY KEY,
    scenario_id NVARCHAR(50) NOT NULL, -- 对应 Neo4j 中的场景 ID
    victim_ip NVARCHAR(50),
    attacker_ip NVARCHAR(50),          -- 聚合后的主要攻击源 IP
    start_time DATETIME,
    end_time DATETIME,
    confidence NVARCHAR(20),           -- High, Medium, Low
    attribution_type NVARCHAR(50),     -- "Known APT" 或 "Unknown Actor"
    attribution_name NVARCHAR(100),    -- 组织名称 (如 APT28) 或 Profile ID
    report_json NVARCHAR(MAX),         -- 存储完整的分析详情 (JSON)
    created_at DATETIME DEFAULT GETDATE()
);
```



### 一些数据库操作：

---

删除一个表里的所有数据：

```sql
DELETE FROM [dbo].[NetworkTraffic];
PRINT '已使用 DELETE 清空表，影响行数：' + CAST(@@ROWCOUNT AS VARCHAR(20));
GO
```

